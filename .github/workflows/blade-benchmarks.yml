name: benchmarks

# Controls when the workflow will run
on:
  pull_request:
    branches: [ benchmark-tests ]
  # Weekly run on every Monday at 12:00 PM UTC (7:00 AM CST).
  schedule:
    - cron: '0 12 * * 1'
  # Allows you to run this workflow manually from the Actions tab.
  # Select the current branch and specify inputs.
  workflow_dispatch:
    inputs:
      bolt:
        description: 'Run Bolt Benchmarks (y/n)'
        required: true
        default: 'y'
      flash:
        description: 'Run Flash Benchmarks (y/n)'
        required: true
        default: 'n'
      
jobs:
  benchmarks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    # Declares workflow dispatch inputs, actions ID, and current branch information for blade session.
    - name: Declare variables
      shell: bash
      run: |
        echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        echo "##[set-output name=run_id;]$(echo ${{ github.run_id }})"
        echo "##[set-output name=bolt;]$(echo ${{ github.event.inputs.bolt }})"
        echo "##[set-output name=flash;]$(echo ${{ github.event.inputs.flash }})"
      id: vars
    - name: Run Benchmark Tests
      uses: fifsky/ssh-action@master
      with:
        # SSH into blade cluster and run this series of commands.
        command: |
          export RUN_ID=${{ steps.vars.outputs.run_id }}
          export RUN_BOLT=${{ steps.vars.outputs.bolt }}
          export RUN_FLASH=${{ steps.vars.outputs.flash }}

          rm -rf Universe
          git clone --branch ${{ steps.vars.outputs.branch }} git@github.com:ThirdAILabs/Universe.git
          cd Universe
          pip3 install .
          bash bin/regular-benchmark.sh
        host: ${{ secrets.HOST }}
        user: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}